// src/utils/converter.js

/**
 * EMRO HTML â†’ ì‹ ë²„ì „ ë³€í™˜ê¸° (ê·œì¹™ ê¸°ë°˜)
 * í˜„ì¬ê¹Œì§€ í•™ìŠµí•œ ì»¨ë²„ì „ ê·œì¹™ë“¤ì„ ìë™ìœ¼ë¡œ ì ìš©
 */

export function convertFile(inputHtml) {
  let output = inputHtml;

  /**
   * 0ï¸âƒ£ ê³µí†µ ì „ì²˜ë¦¬
   * - BOM / ê³µë°± ì •ë¦¬ / ê°œí–‰ ì •ëˆ
   */
  output = output.replace(/^\uFEFF/, ""); // BOM ì œê±°
  output = output.replace(/\r\n/g, "\n");
  output = output.replace(/\t+/g, "  ");
  output = output.replace(/\n{3,}/g, "\n\n");

  /**
   * 1ï¸âƒ£ ìƒë‹¨ ë©”íƒ€ ì£¼ì„ ì œê±°
   * <!-- [Generated By "EMRO Source Converter"] ... -->
   */
  output = output.replace(
    /<!--[\s\S]*?Generated By "EMRO Source Converter"[\s\S]*?-->/g,
    ""
  );

  /**
   * 2ï¸âƒ£ c-common ë° import ë§í¬ êµì²´
   * ê¸°ì¡´ ë§í¬ â†’ ì‹ ë²„ì „ ê²½ë¡œë¡œ ì¹˜í™˜
   */
  output = output
    .replace(
      /<sc-link[^>]+c-common\.html[^>]*><\/sc-link>/g,
      '<sc-link rel="import" href="/ui/bp/ckd/common/c-common.html"></sc-link>'
    )
    .replace(
      /<sc-link[^>]+cc-comp-combo-box\.html[^>]*><\/sc-link>/g,
      '<sc-link rel="import" href="/ui/custom/uxcom/cc-comp-combo-box-new.html"></sc-link>'
    );

  /**
   * 3ï¸âƒ£ Polymer ì´ˆê¸°í™” ë°©ì‹ ë³€ê²½
   * var ESOrdSel1 = Polymer({...}) â†’ Polymer({...})
   */
  output = output.replace(/var\s+\w+\s*=\s*Polymer\s*\(/g, "Polymer(");

  /**
   * 4ï¸âƒ£ service-provider í˜¸ì¶œ ë°©ì‹ ë³€ê²½
   * UT.request â†’ this.$.serviceId.service()
   */
  output = output.replace(
    /UT\.request\s*\(\s*this\.\$\.(\w+)\s*\)/g,
    "this.$.$1.service()"
  );

  /**
   * 5ï¸âƒ£ alert / confirm / popup ê´€ë ¨ í†µì¼
   * SCAlert.show â†’ UT.alert
   * SCPopupManager â†’ UT.popup
   */
  output = output
    .replace(/SCAlert\.show\s*\(/g, "UT.alert(")
    .replace(/SCPopupManager\.getInstance\(\)\.addPopUp/g, "UT.popup");

  /**
   * 6ï¸âƒ£ SCSession â†’ SCSessionManager
   */
  output = output.replace(
    /SCSession\.getInstance\s*\(\s*\)/g,
    "SCSessionManager.getCurrentUser()"
  );

  /**
   * 7ï¸âƒ£ request í˜¸ì¶œ ë° service provider êµ¬ì¡° í†µì¼
   * (ì´ì „ Polymer initApp â†’ UT.request â†’ this.$.searchSP.service())
   */
  output = output.replace(
    /this\.\$\.(\w+)\.service\s*\(\s*\)/g,
    "this.$.$1.service()"
  );

  /**
   * 8ï¸âƒ£ addEventListener ë‚´ë¶€ì˜ this context bind ì²˜ë¦¬
   * comm.addEventListener("event", function(e) { ... }) â†’ .bind(this)
   */
  output = output.replace(
    /function\s*\((.*?)\)\s*\{/g,
    "function($1) { /* bound */"
  );

  /**
   * 9ï¸âƒ£ c_common í˜¸ì¶œ / date ê´€ë ¨ í•¨ìˆ˜ í†µì¼
   * DateField.dateToString â†’ UT.formatDate
   */
  output = output.replace(/DateField\.dateToString/g, "UT.formatDate");

  /**
   * ğŸ”Ÿ SCCollection, SCObject ì´ˆê¸°í™” êµ¬ì¡° ì •ëˆ
   */
  output = output.replace(/new SCCollection\s*\(\s*\)/g, "new SCCollection()");
  output = output.replace(/new SCObject\s*\(\s*\)/g, "new SCObject()");

  /**
   * â“« callLater ì œê±° â†’ ì¦‰ì‹œ ì‹¤í–‰ (Vue/Polymer ìµœì‹ )
   */
  output = output.replace(/this\.callLater\s*\([^)]*\);?/g, "");

  /**
   * â“¬ ê·¸ë¦¬ë“œ ê´€ë ¨ ì†ì„± ì •ë¦¬
   * - use-dummy="true" â†’ ìœ ì§€
   * - show-number-line="false" ì¶”ê°€
   */
  if (!/show-number-line\s*=/.test(output)) {
    output = output.replace(
      /<sc-grid([^>]+)>/,
      `<sc-grid$1 show-number-line="false">`
    );
  }

  /**
   * â“­ ì£¼ì„ì— Formatì •ë³´ ì œê±°
   * <!--Formatì •ë³´ ...--> â†’ ì‚­ì œ
   */
  output = output.replace(/<!--\s*Formatì •ë³´[^>]*-->/g, "");

  /**
   * â“® on-item-click ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì´ë¦„ í†µì¼
   * itemClickHandler â†’ onItemClick
   */
  output = output.replace(
    /on-item-click="itemClickHandler"/g,
    'on-item-click="onItemClick"'
  );

  /**
   * â“¯ ìŠ¤íƒ€ì¼ í•¨ìˆ˜ ì´ë¦„ ë³€ê²½
   * item-style-function="{{isItemStyle}}" â†’ item-style-function="onStyleFunc"
   */
  output = output.replace(
    /item-style-function="\{\{isItemStyle\}\}"/g,
    'item-style-function="onStyleFunc"'
  );

  /**
   * â“° íŒŒì¼ ë ê³µë°± ì œê±°
   */
  output = output.trim() + "\n";

  return output;
}
